<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <title>Add Watermark to PDF Online | Text & Image Stamp Free - The PDF Mechanic</title>
    <meta name="description" content="Securely add text or image watermarks to PDF files online. Customize opacity, rotation, and position. 100% Client-side privacy, no file uploads." />
    <meta name="keywords" content="watermark pdf, add logo to pdf, stamp pdf, pdf copyright tool, free online watermark, secure pdf tool, image to pdf watermark, pdf stamper, add text to pdf, client-side pdf watermark" />
    <meta name="author" content="The PDF Mechanic" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://www.pdfmechanic.com/watermark.html" />

    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.pdfmechanic.com/watermark.html" />
    <meta property="og:title" content="Watermark PDF - Free & Secure" />
    <meta property="og:description" content="Add custom text or logo watermarks to your PDF documents instantly." />
    <meta property="og:image" content="https://www.pdfmechanic.com/og-watermark.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Watermark PDF - Free & Secure" />
    <meta name="twitter:description" content="Add custom text or logo watermarks to your PDF documents instantly." />

    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { brand: '#f59e0b', brandDark: '#d97706', bg: '#F3F4F6' },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "PDF Watermark Tool",
      "applicationCategory": "ProductivityApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "A free online tool to add text or image watermarks to PDF files securely within the browser."
    }
    </script>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [{
        "@type": "Question",
        "name": "Is this watermark tool free?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes, The PDF Mechanic watermark tool is 100% free with no hidden charges."
        }
      },{
        "@type": "Question",
        "name": "Can I use my company logo?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes, you can upload PNG or JPG images to use as a watermark."
        }
      },{
        "@type": "Question",
        "name": "Is my document safe?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Absolutely. We use client-side processing, meaning your file never leaves your browser."
        }
      },{
        "@type": "Question",
        "name": "Can I rotate the watermark?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes, you can rotate the watermark text or image to any angle using the slider."
        }
      },{
        "@type": "Question",
        "name": "Does it work on Mobile?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes, it is fully responsive and works on Android and iOS devices."
        }
      }]
    }
    </script>

    <style>
        /* Smooth Animations */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] summary ~ * { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { 0% { opacity: 0; transform: translateY(-5px); } 100% { opacity: 1; transform: translateY(0); } }

        /* Preview Window */
        #previewContainer {
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            display: inline-block;
            background: #9ca3af; /* Gray background for contrast */
        }
        /* Overlay Common Styles */
        .watermark-overlay {
            position: absolute;
            transform-origin: center center;
            pointer-events: none;
            z-index: 10;
            white-space: nowrap;
        }
        
        /* Form Styling Fix */
        .input-field { 
            width: 100%; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            padding: 0.5rem; 
            outline: none; 
            transition: all 0.2s; 
        }
        .input-field:focus { 
            border-color: #f59e0b; 
            box-shadow: 0 0 0 2px #f59e0b; /* Fixed: Replaced 'ring' with box-shadow */
        }
        .label-text { 
            display: flex; 
            justify-content: space-between; 
            font-size: 0.875rem; 
            font-weight: 600; 
            color: #374151; 
            margin-bottom: 0.25rem; 
        }
    </style>
</head>
<body class="font-sans bg-bg text-gray-900 flex flex-col min-h-screen">

    <nav class="w-full bg-brand text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <a href="index.html" class="font-bold text-xl flex items-center gap-2 hover:opacity-90 transition">
                <i class="fa-solid fa-stamp"></i> The PDF Mechanic
            </a>
            <a href="index.html" class="text-sm bg-white/10 px-3 py-1 rounded hover:bg-white/20 transition">Back to Tools</a>
        </div>
    </nav>

    <div class="bg-white border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <nav class="flex text-sm text-gray-500">
                <ol class="inline-flex items-center space-x-1">
                    <li><a href="index.html" class="hover:text-brand">Home</a></li>
                    <li><i class="fa-solid fa-chevron-right text-xs mx-2"></i></li>
                    <li class="text-gray-800 font-medium">Watermark PDF</li>
                </ol>
            </nav>
        </div>
    </div>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-12 w-full">
        
        <div class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-4">Add Watermark to PDF Online</h1>
            <p class="text-lg text-gray-600 max-w-2xl mx-auto">Protect your documents. Add Custom Text or Image Logos as watermarks. Move, Resize & Rotate freely.</p>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border-t-8 border-brand overflow-hidden mb-16">
            
            <div class="p-6 md:p-10">
                
                <div id="uploadArea" class="border-3 border-dashed border-gray-300 rounded-2xl p-12 text-center hover:bg-orange-50 hover:border-brand transition cursor-pointer group relative" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept="application/pdf" class="hidden">
                    <div class="absolute top-4 right-4 bg-orange-100 text-brand text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Free</div>
                    <div class="text-brand text-7xl mb-6 group-hover:scale-110 transition duration-300 drop-shadow-sm"><i class="fa-solid fa-file-shield"></i></div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">Select PDF File</h3>
                    <p class="text-gray-500">or drop PDF here</p>
                </div>

                <div id="settingsArea" class="hidden">
                    
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded mb-6 border">
                        <span id="fileName" class="font-bold text-gray-700 text-sm">file.pdf</span>
                        <button onclick="location.reload()" class="text-red-500 hover:text-red-700"><i class="fa-solid fa-xmark"></i></button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        <div class="lg:col-span-4 space-y-6">
                            
                            <div class="flex bg-gray-100 p-1 rounded-lg">
                                <button onclick="switchTab('text')" id="tab-text" class="flex-1 py-2 rounded-md font-bold text-sm shadow-sm bg-white text-brand transition">Text</button>
                                <button onclick="switchTab('image')" id="tab-image" class="flex-1 py-2 rounded-md font-bold text-sm text-gray-500 hover:text-gray-700 transition">Image</button>
                            </div>

                            <div id="controls-text" class="space-y-4">
                                <div>
                                    <label class="label-text">Watermark Text</label>
                                    <input type="text" id="wmText" value="CONFIDENTIAL" class="input-field">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="label-text">Color</label>
                                        <select id="wmColor" class="input-field cursor-pointer bg-white">
                                            <option value="gray">Gray</option>
                                            <option value="red">Red</option>
                                            <option value="black">Black</option>
                                            <option value="blue">Blue</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="label-text">Font Size</label>
                                        <input type="number" id="wmFontSize" value="60" class="input-field">
                                    </div>
                                </div>
                            </div>

                            <div id="controls-image" class="space-y-4 hidden">
                                <div>
                                    <label class="label-text">Upload Logo (PNG/JPG)</label>
                                    <input type="file" id="imageInput" accept="image/*" class="input-field p-2 bg-white">
                                </div>
                                <div>
                                    <label class="label-text">Image Size (Scale)</label>
                                    <input type="range" id="wmImageScale" min="10" max="200" value="50" class="w-full accent-brand h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                            </div>

                            <div class="bg-gray-50 p-5 rounded-xl border border-gray-200 space-y-5">
                                <h4 class="font-bold text-gray-700 text-xs uppercase border-b border-gray-300 pb-2 mb-2 tracking-wider">Position & Style</h4>
                                
                                <div>
                                    <label class="label-text">Opacity: <span id="valOpacity" class="text-brand">50%</span></label>
                                    <input type="range" id="wmOpacity" min="0.1" max="1" step="0.1" value="0.5" class="w-full accent-brand h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <label class="label-text">Rotation: <span id="valRotate" class="text-brand">45°</span></label>
                                    <input type="range" id="wmRotate" min="-180" max="180" step="5" value="45" class="w-full accent-brand h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>

                                <div>
                                    <label class="label-text">Horizontal (X)</label>
                                    <input type="range" id="posX" min="0" max="100" value="50" class="w-full accent-brand h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div>
                                    <label class="label-text">Vertical (Y)</label>
                                    <input type="range" id="posY" min="0" max="100" value="50" class="w-full accent-brand h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                                </div>
                                <div class="text-center">
                                    <button onclick="resetPosition()" class="text-xs text-brand hover:text-brandDark underline cursor-pointer font-medium">Reset to Center</button>
                                </div>
                            </div>

                            <button id="processBtn" class="w-full bg-brand text-white py-4 rounded-xl font-bold shadow-lg hover:bg-brandDark transform transition hover:-translate-y-1">
                                <i class="fa-solid fa-download mr-2"></i> Download Watermarked PDF
                            </button>
                        </div>

                        <div class="lg:col-span-8 flex flex-col items-center bg-gray-100 rounded-xl p-4 min-h-[500px] justify-center relative border border-gray-200">
                            <h3 class="absolute top-4 left-4 font-bold text-gray-500 text-xs uppercase bg-white px-2 py-1 rounded shadow-sm">Live Preview (Page 1)</h3>
                            
                            <div id="previewContainer">
                                <canvas id="pdfPreview"></canvas>
                                <div id="textOverlay" class="watermark-overlay">CONFIDENTIAL</div>
                                <img id="imageOverlay" class="watermark-overlay hidden" src="" alt="watermark">
                            </div>
                            <p class="absolute bottom-4 text-xs text-gray-400">Preview shows position approximation.</p>
                        </div>

                    </div>
                </div>

                <div id="downloadArea" class="hidden text-center py-10">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6 animate-bounce">
                        <i class="fa-solid fa-check text-4xl text-green-600"></i>
                    </div>
                    <h3 class="text-3xl font-bold text-gray-800 mb-2">Success!</h3>
                    <p class="text-gray-600 mb-8">Your watermark has been applied.</p>
                    
                    <button id="downloadBtn" class="bg-brand text-white px-10 py-4 rounded-xl font-bold text-xl shadow-lg hover:bg-brandDark transition transform hover:-translate-y-1">
                        Download File
                    </button>
                    
                    <button onclick="location.reload()" class="block mx-auto mt-8 text-gray-500 hover:text-brand underline text-sm font-medium">
                        <i class="fa-solid fa-rotate-right mr-1"></i> Start Over
                    </button>
                </div>

            </div>
            
            <div class="bg-gray-50 p-4 border-t border-gray-200 flex justify-center items-center gap-6 text-sm text-gray-500 flex-wrap">
                <span class="flex items-center gap-2"><i class="fa-solid fa-shield-halved text-brand"></i> Secure Client-Side</span>
                <span class="flex items-center gap-2"><i class="fa-solid fa-bolt text-brand"></i> Instant Processing</span>
                <span class="flex items-center gap-2"><i class="fa-solid fa-ban text-brand"></i> No Server Uploads</span>
            </div>
        </div>
        <section class="mb-16">
            <h2 class="text-3xl font-bold text-gray-900 text-center mb-10">How to Add Watermark to PDF?</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition">
                    <div class="w-14 h-14 bg-orange-100 text-brand rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">1</div>
                    <h3 class="font-bold text-xl mb-3">Upload PDF</h3>
                    <p class="text-gray-600">Select your PDF file from your device. It stays secure in your browser.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition">
                    <div class="w-14 h-14 bg-orange-100 text-brand rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">2</div>
                    <h3 class="font-bold text-xl mb-3">Customize Stamp</h3>
                    <p class="text-gray-600">Type text or upload a logo. Adjust opacity, rotation, and position using live preview.</p>
                </div>
                <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center hover:shadow-md transition">
                    <div class="w-14 h-14 bg-orange-100 text-brand rounded-full flex items-center justify-center mx-auto mb-4 text-2xl font-bold">3</div>
                    <h3 class="font-bold text-xl mb-3">Download</h3>
                    <p class="text-gray-600">Click download to get your stamped PDF instantly without quality loss.</p>
                </div>
            </div>
        </section>

        <section class="bg-white p-8 md:p-12 rounded-2xl shadow-sm border border-gray-200 mb-16">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                <div>
                    <span class="bg-orange-100 text-brand text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Security</span>
                    <h2 class="text-3xl font-bold text-gray-900 mt-4 mb-6">Why You Should Watermark Your Documents?</h2>
                    <div class="prose text-gray-700 space-y-4">
                        <p>
                            Watermarking is essential for protecting intellectual property and maintaining document integrity. Whether it's a "CONFIDENTIAL" stamp on a contract or your company logo on a report, it ensures ownership is clear.
                        </p>
                        <ul class="list-disc pl-5 space-y-2">
                            <li><strong>Copyright Protection:</strong> Prevent unauthorized use of your creative work.</li>
                            <li><strong>Status Tracking:</strong> Clearly mark files as DRAFT, REVIEW, or FINAL.</li>
                            <li><strong>Brand Awareness:</strong> Ensure your brand is visible on every page shared.</li>
                        </ul>
                    </div>
                </div>
                <div>
                    <div class="bg-gray-50 p-8 rounded-xl border border-gray-200">
                        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-user-shield text-brand"></i> Privacy First Approach
                        </h3>
                        <p class="text-gray-600 leading-relaxed mb-4">
                            Unlike other online tools, <strong>The PDF Mechanic</strong> processes your files 100% Client-Side. 
                        </p>
                        <p class="text-gray-600 leading-relaxed">
                            This means your sensitive legal documents, invoices, or manuscripts <strong>never leave your computer</strong>. The watermarking happens right inside your Chrome, Edge, or Firefox browser using advanced WebAssembly technology.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section class="max-w-4xl mx-auto">
            <h2 class="text-3xl font-bold text-center text-gray-900 mb-10">Frequently Asked Questions</h2>
            <div class="space-y-4">
                
                <details class="group bg-white p-6 rounded-xl border border-gray-200 cursor-pointer transition hover:shadow-md">
                    <summary class="flex justify-between items-center font-bold text-gray-800 list-none">
                        <span>Is this tool free?</span>
                        <span class="text-brand transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                    </summary>
                    <p class="text-gray-600 mt-3 text-sm leading-relaxed">Yes, The PDF Mechanic is completely free to use. There are no limits on the number of files you can watermark.</p>
                </details>

                <details class="group bg-white p-6 rounded-xl border border-gray-200 cursor-pointer transition hover:shadow-md">
                    <summary class="flex justify-between items-center font-bold text-gray-800 list-none">
                        <span>Can I upload my own image logo?</span>
                        <span class="text-brand transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                    </summary>
                    <p class="text-gray-600 mt-3 text-sm leading-relaxed">Yes! Switch to the "Image" tab and upload any PNG or JPG file. You can then resize and position it anywhere on the page.</p>
                </details>

                <details class="group bg-white p-6 rounded-xl border border-gray-200 cursor-pointer transition hover:shadow-md">
                    <summary class="flex justify-between items-center font-bold text-gray-800 list-none">
                        <span>Can I remove a watermark later?</span>
                        <span class="text-brand transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                    </summary>
                    <p class="text-gray-600 mt-3 text-sm leading-relaxed">Once a PDF is flattened and saved, the watermark becomes permanent. We recommend always keeping a copy of your original file.</p>
                </details>

                <details class="group bg-white p-6 rounded-xl border border-gray-200 cursor-pointer transition hover:shadow-md">
                    <summary class="flex justify-between items-center font-bold text-gray-800 list-none">
                        <span>Does it work on mobile phones?</span>
                        <span class="text-brand transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                    </summary>
                    <p class="text-gray-600 mt-3 text-sm leading-relaxed">Yes, the tool is fully responsive and works smoothly on Android and iPhone browsers.</p>
                </details>

                <details class="group bg-white p-6 rounded-xl border border-gray-200 cursor-pointer transition hover:shadow-md">
                    <summary class="flex justify-between items-center font-bold text-gray-800 list-none">
                        <span>Are my files saved on your server?</span>
                        <span class="text-brand transition group-open:rotate-180"><i class="fa-solid fa-chevron-down"></i></span>
                    </summary>
                    <p class="text-gray-600 mt-3 text-sm leading-relaxed">No. We use client-side technology. Your files stay on your device and are processed locally for maximum privacy.</p>
                </details>

            </div>
        </section>

    </main>

    <footer class="bg-gray-900 text-white pt-16 pb-8 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-12">
                
                <div class="col-span-1 md:col-span-1">
                    <h3 class="text-2xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-wrench text-brand"></i> The PDF Mechanic</h3>
                    <p class="text-gray-400 text-sm leading-relaxed">
                        Secure, privacy-focused online PDF tools. Process your documents locally without uploading them to servers.
                    </p>
                </div>

                <div>
                    <h4 class="text-lg font-semibold mb-4 text-gray-200 border-b border-gray-700 pb-2">Convert</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="pdf-to-word.html" class="hover:text-brand transition">PDF to Word</a></li>
                        <li><a href="word-to-pdf.html" class="hover:text-brand transition">Word to PDF</a></li>
                        <li><a href="images-to-pdf.html" class="hover:text-brand transition">JPG to PDF</a></li>
                        <li><a href="pdf-to-images.html" class="hover:text-brand transition">PDF to JPG</a></li>
                        <li><a href="pdf-to-excel.html" class="hover:text-brand transition">PDF to Excel</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-lg font-semibold mb-4 text-gray-200 border-b border-gray-700 pb-2">Organize</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="merger.html" class="hover:text-brand transition">Merge PDF</a></li>
                        <li><a href="splitter.html" class="hover:text-brand transition">Split PDF</a></li>
                        <li><a href="delete-pages.html" class="hover:text-brand transition">Delete Pages</a></li>
                        <li><a href="add-page-numbers.html" class="hover:text-brand transition">Add Page Numbers</a></li>
                        <li><a href="watermark.html" class="text-white font-bold">Watermark PDF</a></li>
                    </ul>
                </div>

                <div>
                    <h4 class="text-lg font-semibold mb-4 text-gray-200 border-b border-gray-700 pb-2">Edit & Sign</h4>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li><a href="compressor.html" class="hover:text-brand transition">Compress PDF</a></li>
                        <li><a href="ocr.html" class="hover:text-brand transition">OCR PDF</a></li>
                        <li><a href="pdf-editor.html" class="hover:text-brand transition">PDF Editor</a></li>
                        <li><a href="esign.html" class="hover:text-brand transition">eSign PDF</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-gray-800 pt-8 text-center text-sm text-gray-500 flex flex-col md:flex-row justify-between items-center gap-4">
                <p>© <span id="year"></span> The PDF Mechanic. All rights reserved.</p>
                <div class="flex gap-4">
                    <a href="#" class="hover:text-white transition">Privacy Policy</a>
                    <a href="#" class="hover:text-white transition">Terms of Use</a>
                    <a href="#" class="hover:text-white transition">Contact</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- VARIABLES ---
        let currentMode = 'text'; // 'text' or 'image'
        let currentFile = null;
        let uploadedImageBytes = null; // For PDF-Lib
        let uploadedImageUrl = null;   // For Preview
        let pdfDocBytes = null;
        let pdfPageWidth = 0;
        let pdfPageHeight = 0;

        // Elements
        const fileInput = document.getElementById('fileInput');
        const imageInput = document.getElementById('imageInput');
        const canvas = document.getElementById('pdfPreview');
        const ctx = canvas.getContext('2d');
        
        // Overlays
        const textOverlay = document.getElementById('textOverlay');
        const imageOverlay = document.getElementById('imageOverlay');

        // Inputs
        const inputs = {
            text: document.getElementById('wmText'),
            color: document.getElementById('wmColor'),
            fontSize: document.getElementById('wmFontSize'),
            opacity: document.getElementById('wmOpacity'),
            rotate: document.getElementById('wmRotate'),
            posX: document.getElementById('posX'),
            posY: document.getElementById('posY'),
            imgScale: document.getElementById('wmImageScale')
        };

        // --- 1. INITIALIZATION ---
        fileInput.addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                currentFile = e.target.files[0];
                document.getElementById('fileName').innerText = currentFile.name;
                document.getElementById('uploadArea').classList.add('hidden');
                document.getElementById('settingsArea').classList.remove('hidden');
                await renderPreview();
            }
        });

        imageInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const file = e.target.files[0];
                uploadedImageUrl = URL.createObjectURL(file);
                
                // Read bytes for PDF-Lib
                const reader = new FileReader();
                reader.onload = (evt) => { uploadedImageBytes = evt.target.result; updatePreview(); };
                reader.readAsArrayBuffer(file);
                
                // Set Preview Image
                imageOverlay.src = uploadedImageUrl;
            }
        });

        // Add Listeners to all inputs
        Object.values(inputs).forEach(el => el.addEventListener('input', updatePreview));

        // --- 2. TABS Logic ---
        window.switchTab = (mode) => {
            currentMode = mode;
            // Toggle UI
            document.getElementById('tab-text').className = mode === 'text' ? 'flex-1 py-2 rounded-md font-bold text-sm shadow-sm bg-white text-brand transition' : 'flex-1 py-2 rounded-md font-bold text-sm text-gray-500 hover:text-gray-700 transition';
            document.getElementById('tab-image').className = mode === 'image' ? 'flex-1 py-2 rounded-md font-bold text-sm shadow-sm bg-white text-brand transition' : 'flex-1 py-2 rounded-md font-bold text-sm text-gray-500 hover:text-gray-700 transition';
            
            document.getElementById('controls-text').classList.toggle('hidden', mode !== 'text');
            document.getElementById('controls-image').classList.toggle('hidden', mode !== 'image');
            
            updatePreview();
        };

        window.resetPosition = () => {
            inputs.posX.value = 50;
            inputs.posY.value = 50;
            inputs.rotate.value = 45;
            updatePreview();
        }

        // --- 3. RENDER PDF PREVIEW ---
        async function renderPreview() {
            const arrayBuffer = await currentFile.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const page = await pdf.getPage(1);
            
            const viewport = page.getViewport({ scale: 0.8 }); // Adjust scale for fitting
            canvas.width = viewport.width;
            canvas.height = viewport.height;
            pdfPageWidth = viewport.width; // Store for relative positioning
            pdfPageHeight = viewport.height;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;
            updatePreview();
        }

        // --- 4. UPDATE LIVE OVERLAY ---
        function updatePreview() {
            // Update Values Display
            document.getElementById('valOpacity').innerText = Math.round(inputs.opacity.value * 100) + '%';
            document.getElementById('valRotate').innerText = inputs.rotate.value + '°';

            const xPercent = inputs.posX.value;
            const yPercent = 100 - inputs.posY.value; // Invert Y for CSS top logic
            const rotate = inputs.rotate.value;
            const opacity = inputs.opacity.value;

            // Common Style
            const style = `
                left: ${xPercent}%;
                top: ${yPercent}%;
                transform: translate(-50%, -50%) rotate(${rotate * -1}deg); /* CSS Rotate is opposite to PDF usually */
                opacity: ${opacity};
            `;

            if (currentMode === 'text') {
                textOverlay.classList.remove('hidden');
                imageOverlay.classList.add('hidden');
                
                const colorMap = { 'gray': '#808080', 'red': '#ef4444', 'black': '#000000', 'blue': '#3b82f6' };
                
                textOverlay.innerText = inputs.text.value || "";
                textOverlay.style.cssText = style + `
                    font-size: ${inputs.fontSize.value}px;
                    color: ${colorMap[inputs.color.value]};
                    font-family: Helvetica, sans-serif;
                    font-weight: bold;
                `;
            } else {
                textOverlay.classList.add('hidden');
                imageOverlay.classList.remove('hidden');
                
                if (uploadedImageUrl) {
                    const scale = inputs.imgScale.value; // simple width px for preview
                    imageOverlay.style.cssText = style + `width: ${scale * 2}px;`;
                }
            }
        }

        // --- 5. GENERATE PDF (DOWNLOAD) ---
        document.getElementById('processBtn').addEventListener('click', async () => {
            const btn = document.getElementById('processBtn');
            btn.innerHTML = 'Processing...';
            btn.disabled = true;

            try {
                const { PDFDocument, rgb, degrees, StandardFonts } = PDFLib;
                const pdfDoc = await PDFDocument.load(await currentFile.arrayBuffer());
                const pages = pdfDoc.getPages();
                const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

                // Get Values
                const opacity = parseFloat(inputs.opacity.value);
                const rotation = parseInt(inputs.rotate.value);
                
                // Colors
                let colorObj = rgb(0.5, 0.5, 0.5);
                if(inputs.color.value === 'red') colorObj = rgb(0.9, 0.2, 0.2);
                if(inputs.color.value === 'black') colorObj = rgb(0, 0, 0);
                if(inputs.color.value === 'blue') colorObj = rgb(0, 0, 1);

                // Prepare Image if needed
                let embedImg = null;
                let imgDims = null;
                if (currentMode === 'image' && uploadedImageBytes) {
                    try {
                        embedImg = await pdfDoc.embedPng(uploadedImageBytes);
                    } catch (e) {
                        embedImg = await pdfDoc.embedJpg(uploadedImageBytes);
                    }
                    
                    const scaleFactor = parseInt(inputs.imgScale.value) / 100; // Arbitrary scaler
                    // Scale image relative to page size logic can be improved, 
                    // but here we use the image's native size * user scale
                    imgDims = embedImg.scale(scaleFactor); 
                }

                pages.forEach(page => {
                    const { width, height } = page.getSize();
                    
                    // Coordinates Calculation
                    // Sliders are 0-100%. 
                    const x = (parseFloat(inputs.posX.value) / 100) * width;
                    const y = (parseFloat(inputs.posY.value) / 100) * height;

                    if (currentMode === 'text') {
                        const fontSize = parseInt(inputs.fontSize.value);
                        const text = inputs.text.value;
                        const textWidth = font.widthOfTextAtSize(text, fontSize);
                        const textHeight = font.heightAtSize(fontSize);

                        // Adjust x,y to be center of the element
                        page.drawText(text, {
                            x: x - (textWidth / 2),
                            y: y - (textHeight / 2), // PDF coordinates start bottom-left
                            size: fontSize,
                            font: font,
                            color: colorObj,
                            opacity: opacity,
                            rotate: degrees(rotation),
                        });
                    } else if (embedImg) {
                        page.drawImage(embedImg, {
                            x: x - (imgDims.width / 2),
                            y: y - (imgDims.height / 2),
                            width: imgDims.width,
                            height: imgDims.height,
                            opacity: opacity,
                            rotate: degrees(rotation),
                        });
                    }
                });

                pdfDocBytes = await pdfDoc.save();
                
                // Show Download
                document.getElementById('settingsArea').classList.add('hidden');
                document.getElementById('downloadArea').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                alert("Error: " + err.message);
                btn.innerHTML = 'Try Again';
                btn.disabled = false;
            }
        });

        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (!pdfDocBytes) return;
            const blob = new Blob([pdfDocBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const name = currentFile.name.replace(/\.[^/.]+$/, "");
            a.download = `${name}-watermarked-thepdfmechanic.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        });

    </script>
</body>
</html>